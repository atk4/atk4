/* Welcome to Agile Toolkit JS framework. This file implements Form. */// The following HTML structure should be used:
//
// <div id='formid'>     <!-- binding to this element -->
// <form action="url">
//   ..
//
//
//   <... class='atk-field'>
//     <input id='formid_fieldid' type=> <!-- could be any type really -->
//     field, etc
//   </...>
//   <error inserts here
//
//   ..repeats..
//
//   <div class="field-error-template" style="display: none"> .<span class="field-error-text">error template</span> </div>
// </form>	
//</div>
jQuery.widget("ui.atk4_form",{form:undefined,id:undefined,submitted:undefined,base_url:undefined,loading:!1,show_loader:!0,plain_submit:!1,template:{},_getChanged:function(){return this.form.hasClass("form_changed")},_setChanged:function(e){if(this.element.is(".ignore_changes")){this.form.removeClass("form_changed");return}e?this.form.addClass("form_changed"):this.form.removeClass("form_changed")},_create:function(){var e=this;this.id=this.element.attr("id");this.form=this.element;if(!this.form.is("form")){this.form=this.form.find("form");this.element.bind("submit",function(t){t.preventDefault();e.submitForm()})}console.log("created with url=",this.form.attr("action"));this.form.prepend('<input name="ajax_submit" id="ajax_submit" value="1" type="hidden"/>');this.form.addClass("atk4_form");this.element.addClass("atk4_form_widget");this.form.find("input").bind("keypress",function(t){if($(this).is(".ui-autocomplete-input"))return!0;if(t.keyCode==13){$(this).trigger("change");e.submitForm();return!1}});this.form.find(":input").each(function(){$(this).attr("type")=="checkbox"?$(this).attr("data-initvalue",$(this).attr("checked")):$(this).attr("data-initvalue",$(this).val())}).bind("change",function(t){if($(this).attr("data-initvalue")==$(this).val()){t.preventDefault();return}$(this).attr("data-initvalue",$(this).val());e._setChanged(!0)});this.form.find("input[type=radio]").click(function(){e._setChanged(!0)}).change(function(){e._setChanged(!0)});this.template.field_error=this.element.find(".field-error-template").remove();this.template.field_error.length||console.log("Warning: form template does not have form-error-template class");this.form.submit(function(t){if(e.plain_submit){t.stopPropagation();e.plain_submit=!1;return}t.stopPropagation();t.preventDefault();e.submitForm()});this.base_url=window.location.href.substr(0,window.location.href.indexOf("#"));this.base_url||(this.base_url=window.location.href);this.options.base_url&&(this.base_url=this.options.base_url)},submitPlain:function(){this.plain_submit=!0;this.form.trigger("submit")},setFieldValue:function(e,t){var n=$("#"+this.id+"_"+e);if(!n.length){console.log("Unable to find field ",e," and fill in ",t);return}if(n.hasClass("field_reference")){var r=n.find("option[value="+t+"]");if(r.length){n.val(t).change().trigger("change_ref");return}var i=this;this.reloadField(e,null,function(){var n=$("#"+i.id+"_"+e),r=n.find("option[value="+t+"]");r.length?n.val(t).change().trigger("change_ref"):console.log("even after field reload, couldnt select ",t," for ",e)});return}n.val(t).change()},reloadField:function(e,t,n,r,i){var s=$("#"+this.id+' [data-shortname="'+e+'"]').first().attr("id");t||(t=this.form.attr("action"));i&&$.each(i,function(e,n){t=$.atk4.addArgument(t,e+"="+encodeURIComponent(n))});t=$.atk4.addArgument(t,this.id+"_cut_field",s);var o=$("#"+s);console.log("Field found: ",s,"->",o);r||o.trigger("reload_field");var u=o.closest(".atk-form-field");o=u;var a=this._getChanged();this._setChanged(!1);o.atk4_load(t,n);this._setChanged(a)},fieldError:function(e,t){if(this.options.error_handler)return this.options.error_handler(e,t);var n=typeof e=="string"?$('[data-shortname="'+e+'"]',"#"+this.id):e;n.length||(n=this.form.find('[name="'+e+'"]'));if(!n.length){alert("Field not found: "+e+", error is: "+t);return}if(!t||t=="0")t="must be specified properly";n.focus();n.closest("form").find(".field_error").remove();var r=n.closest(".atk-form-row").addClass("has-error").find(".atk-form-field");n.closest(".atk-form-row").find(".atk-form-label").addClass("atk-effect-danger");r.children(".atk-form-error").remove();if(!this.template.field_error.length){alert(t);return}var i=this.template.field_error.clone();i.find(".field-error-text").add(i.filter(".field-error-text")).text(t);i.appendTo(r).fadeIn();this.form.addClass("form_has_error");i.click(function(){$(this).closest(".has-error").removeClass("has-error").find(".atk-form-label").removeClass("atk-effect-danger");i.remove()});var s=this;n.bind("change.errorhide",function(){var e=$(this);e.unbind("change.errorhide");s.form.removeClass("form_has_error").find(".atk-form-label").removeClass("atk-effect-danger");r.closest(".has-error").removeClass("has-error");i.fadeOut(function(){i.remove()})})},clearError:function(e){e?e=e.closest(".has-error"):e=this.form.find(".has-error");e.find(".atk-form-error").remove();e.removeClass("has-error")},submitForm:function(btn){var params={},form=this;if(form.loading){$.univ().loadingInProgress();return!1}this.form.trigger("beforesubmit");var richtext=form.element.find(".atk4_richtext");richtext.length&&richtext.atk4_richtext("changeHTML");params=form.element.find(":input").serializeArray();if(btn)for(var el in params)if(params[el].name=="ajax_submit"){params[el].value=btn;break}var properties={type:"POST",url:form.form.attr("action")};form.loading=!0;form.show_loader&&form.element.atk4_loader().atk4_loader("showLoader");form.element.find(":input:enabled").attr("disabled",!0).attr("reenable",!0);$.atk4.get(properties,params,function(res){var c=form._getChanged();form._setChanged(!1);if(!$.atk4._checkSession(res))return;try{eval(res)}catch(e){w=window.open(null,null,"height=400,width=700,location=no,menubar=no,scrollbars=yes,status=no,titlebar=no,toolbar=no");if(w){w.document.write("<h5>Error in AJAX response: "+e+"</h5>");w.document.write(res);w.document.write('<center><input type=button onclick="window.close()" value="Close"></center>')}else alert("Error in AJAX response: "+e+"\n"+res)}form._setChanged(c)},function(){form.loading=!1;form.show_loader&&form.element.atk4_loader().atk4_loader("hideLoader");form.element.find(":input[reenable]").removeAttr("disabled").removeAttr("reenable")})}});